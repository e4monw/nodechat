<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Nodechat 2</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>

    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <link rel="shortcut icon" href="favicon.ico" type="image/ico" />

    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font: 16px Helvetica, Arial; color: black; background: white;}
    form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
    form input { border: 0; padding: 10px; width: 100%;}
    #title { padding: 10px; margin-top: 10px; margin-bottom: 10px;}
    #motd { padding: 10px; font: 24px Helvetica, Arial, color: black; margin-top: 10px; margin-bottom: 10px}
    #clearchatdiv { float: right; padding: 10px;}
    #clearchatbtn { width: 100px; height: 40px; padding: 10px; font-size: 14px; border-radius: 10px;}
    #messages { list-style-type: none; margin: 0; padding: 10px; overflow-y: auto;}
    #messages li { padding: 3px;}
    #messages li:nth-child(odd) { background: white; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle Navbar</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">Nodechat 2</a>
          </div>            <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
              <li class="active"><a href="http://nodechat.netlify.com/nodechat2">Home</a></li>
              <li><a href="mailto:tszhw2022@student.cis.edu.hk?Subject=Nodechat%20Suggestions" target="_top">Contact Us</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">More<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="https://github.com/fatbu/nodechat/tree/Nodechat-V2">Github Page</a></li>
                  <li><a href="#">Download Nodechat</a></li>
                  <li role="separator" class="divider"></li>
                  <li class="dropdown-header">Other stuff</li>
                  <li><a href="http://nodechat.netlify.com">Nodechat 1</a></li>
                  </ul>
                </li>
              </ul>
            </div><!--/.nav-collapse -->
          </div>
    </nav>
    <hr style="margin-top: 5px;
    margin-bottom: 5px;">

    <h3 id='motd'></h3>
    <hr style="margin-top: 5px;
    margin-bottom: 5px;">

    <div id='clearchatdiv'><button id='clearchatbtn' onclick='$("#messages").empty(); $("#m").focus()'>Clear chat</button></div>
    <audio><source src='ding.m4a'></audio>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" />
    </form>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script>

    function appendMessage(messagetext){
      $('#messages').append($('<li>').text(messagetext));
    }

    appendMessage('Connecting...');
    var socket = io.connect();

    socket.emit('getmotd', function(motd){
      $('#motd').text(motd);
    });


    if(localStorage.banned){
      while(true){
        alert('You have been permanently banned from this server!');
      }
    }

    var nick = prompt('Nickname');
    if(nick.trim() == '' || nick.length < 3){
      alert('Nickname too short');
      location.reload();
    };




    var admin = false;

    socket.on('verified', function(){ // Admin verification
      admin=true;
      socket.emit('chat message', {nickname: 'Server', message: nick + ' is now an operator!'});
    });

    socket.on('chat message', function(data){ // very important thing, obviously
      appendMessage(data.nickname + ': ' + data.message);
      $('audio')[0].play();
    });
    socket.on('usersonline', function(users){
      appendMessage('Users online: ' + users.toString());
    });
    appendMessage('Logging in...');
    socket.emit('userconnect', nick); // Send nickname
    socket.emit('getusers');
    $('form').submit(function(){
      var txt = $('#m').val();
      if(txt.charAt(0)=='/'){


        // Commands!
        // Work in progress
        // P.S. this is hackable xD


        txt = txt.slice(1); // Get rid of the first character

        if(txt.search(/operator/) != -1){ // NEEDS WORK
          if(txt == 'operator'){ // is it JUST /operator? that will print the admin passcode in console
            socket.emit('printadmin');
          }else{
            txt = txt.replace(/operator\s/, '');
            socket.emit('verifyadmin', parseInt(txt));
          }
        }



        if(txt.search(/users/) != -1){
          txt = txt.replace(/users\s/, '');
          socket.emit('getusers');
        }

        if(admin){

          // Admin commands only
          if(txt.search(/permban/) != -1){
            txt = txt.replace(/permban\s/, '');
            if(txt!=nick){
              socket.emit('permban', txt);
            }
          }
          if(txt.search(/mute/) != -1){
            txt = txt.replace(/mute\s/, '');
            if(txt!=nick){
              socket.emit('mute', txt);
            }
          }
          if(txt.search(/motd/) != -1){
            txt = txt.replace(/motd\s/, '');
            socket.emit('motd', txt);
          }
        }

        // Clean up
        $('#m').val('');
        return false;
      }else{
        socket.emit('chat message', {nickname: nick, message: txt});
        $('#m').val('');
        return false;
      }
    });
    socket.on('usernametaken', function(nickname){
      alert('Username taken');
      location.reload();-w
    });
    socket.on('permban', function(user){
      if(nick == user){
        localStorage.banned=true;
        location.reload();
      }
    });
    socket.on('mute', function(user){
      if(nick == user){
        $('#m').remove();
      }
    });
    socket.on('motd', function(motd){
      // NEEDS WORK!
      $('#motd').text(motd);
    });
    window.onbeforeunload = function(){
      socket.emit('userdisconnect', nick);
    }
    </script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>
