<!doctype html>
<html>
  <head>
    <title>Chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 16px Helvetica, Arial; color: white; background: black;}
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 100%;}
			#clearchatdiv { float: right; padding: 10px;}
			#clearchatbtn { width: 100px; height: 40px; padding: 10px; font-size: 14px; border-radius: 10px;}
      #messages { list-style-type: none; margin: 0; padding: 10px; overflow-y: auto;}
      #messages li { padding: 5px;}
      #messages li:nth-child(odd) { background: black; }
    </style>
  </head>
  <body>
		<div id='clearchatdiv'><button id='clearchatbtn' onclick='$("#messages").empty()'>Clear chat</button></div>
		<audio><source src='ding.m4a'></audio>
    <ul id="messages"></ul>
		<div id='typers'></div>
    <form action="">
      <input id="m" autocomplete="off" />
    </form>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
		var nick = prompt('Nickname', 'Guest');
		if(nick.trim() == '' || nick.length < 5){
			location.reload();
		};
    var socket = io.connect();
		var admin = false
		socket.on('verified', function(){
			admin=true;
			socket.emit('chat message', {nickname: 'Server', message: nick + ' is now an operator!'});
		});
		
		socket.emit('userconnect', nick);
		/*
		$('#m').on('input', function(){
			// user typing thingy
			socket.emit('typing', nick);
		});
		socket.on('typing', function(peopletyping){
			$('#typers').html(peopletyping);
		}); // needs work
		*/
    $('form').submit(function(){
			var txt = $('#m').val();
			if(txt.charAt(0)=='/'){ // Only for admins

				// Commands!
				// Work in progress
				// P.S. this is hackable xD
				txt = txt.slice(1);
				
				if(txt.search(/operator/) != -1){ // NEEDS WORK
					txt = txt.replace(/operator\s/, '');
					socket.emit('verifyadmin', parseInt(txt));
				}
				
				if(admin){
					if(txt.search(/mute/) != -1){ // NEEDS WORK
						txt = txt.replace(/mute\s/, '');
						if(txt!=nick){
							socket.emit('mute', txt);
						}
					}
				}
				
				// Clean up
				$('#m').val('');
				return false;
			}else{
      	socket.emit('chat message', {nickname: nick, message: txt});
      	$('#m').val('');
      	return false;
			}
    });
		socket.on('usernametaken', function(nickname){
			alert('Username taken');
			location.reload();
		});
    socket.on('chat message', function(data){
      $('#messages').append($('<li>').text(data.nickname + ': ' + data.message));
			$('audio')[0].play();
		});
		socket.on('mute', function(user){
			if(nick == user){
				$('#m').remove();
			}
		});
		window.onbeforeunload = function(){
			socket.emit('userdisconnect', nick);
		}
		</script>
  </body>
</html>
